<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-learnings" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">Weekly learnings: Week2 | Blog - Vertexcover</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://blog.vertexcover.io/img/vertexcover.png"><meta data-rh="true" name="twitter:image" content="https://blog.vertexcover.io/img/vertexcover.png"><meta data-rh="true" property="og:url" content="https://blog.vertexcover.io/learnings/2025-10-ranjan-week2"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Weekly learnings: Week2 | Blog - Vertexcover"><meta data-rh="true" name="description" content="Developed a comprehensive benchmarking framework for comparing container image formats (regular vs eStargz) for large LLM workloads using containerd and stargz-snapshotter."><meta data-rh="true" property="og:description" content="Developed a comprehensive benchmarking framework for comparing container image formats (regular vs eStargz) for large LLM workloads using containerd and stargz-snapshotter."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-10-22T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/hungerarray"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.vertexcover.io/learnings/2025-10-ranjan-week2"><link data-rh="true" rel="alternate" href="https://blog.vertexcover.io/learnings/2025-10-ranjan-week2" hreflang="en"><link data-rh="true" rel="alternate" href="https://blog.vertexcover.io/learnings/2025-10-ranjan-week2" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://blog.vertexcover.io/learnings/2025-10-ranjan-week2","mainEntityOfPage":"https://blog.vertexcover.io/learnings/2025-10-ranjan-week2","url":"https://blog.vertexcover.io/learnings/2025-10-ranjan-week2","headline":"Weekly learnings: Week2","name":"Weekly learnings: Week2","description":"Developed a comprehensive benchmarking framework for comparing container image formats (regular vs eStargz) for large LLM workloads using containerd and stargz-snapshotter.","datePublished":"2025-10-22T00:00:00.000Z","author":{"@type":"Person","name":"Ranjan Ojha","description":"Software Engineer","url":"https://github.com/hungerarray","image":"https://github.com/hungerarray.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://blog.vertexcover.io/learnings","name":"Learnings"}}</script><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Blog - Vertexcover RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Blog - Vertexcover Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0JS91KNQLR"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0JS91KNQLR",{})</script>




<link rel="alternate" type="application/rss+xml" href="/learnings/rss.xml" title="Blog - Vertexcover RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/learnings/atom.xml" title="Blog - Vertexcover Atom Feed">
<meta name="generator" content="vertex cover"><link rel="stylesheet" href="/assets/css/styles.9909b52a.css">
<script src="/assets/js/runtime~main.4e5a35ed.js" defer="defer"></script>
<script src="/assets/js/main.22422905.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><link rel="preload" as="image" href="https://github.com/hungerarray.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Vertexcover Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Vertexcover Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Vertexcover</b></a><a class="navbar__item navbar__link" href="/">Blog</a><a class="navbar__item navbar__link" href="/projects">Projects</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/learnings">Learnings</a><a class="navbar__item navbar__link" href="/about-us">About Us</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/vertexcover-io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All learnings</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/learnings/2025-10-ranjan-week2">Weekly learnings: Week2</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/learnings/2025-10-aman-week2">AI Video Cutter - Week 2 Learnings</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/learnings/2025-10-ranjan-week1">Weekly learnings: Week1</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/learnings/2025/01/20/ai-video-cutter-week1">AI Video Cutter - Week 1 Learnings</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Weekly learnings: Week2</h1><div class="container_mt6G margin-vert--md"><time datetime="2025-10-22T00:00:00.000Z">October 22, 2025</time> · <!-- -->14 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/learnings/authors/ranjan"><img class="avatar__photo authorImage_XqGP" src="https://github.com/hungerarray.png" alt="Ranjan Ojha"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/learnings/authors/ranjan"><span class="authorName_yefp" translate="no">Ranjan Ojha</span></a></div><small class="authorTitle_nd0D" title="Software Engineer">Software Engineer</small><div class="authorSocials_rSDt"><a href="https://github.com/hungerarray" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a><a href="https://www.linkedin.com/in/ojha-ranjan/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" style="--dark:#0a66c2;--light:#ffffffe6" class="authorSocialIcon_XYv3 linkedinSvg_FCgI"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Developed a comprehensive benchmarking framework for comparing container image formats (regular vs eStargz) for large LLM workloads using containerd and stargz-snapshotter.</p>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="key-findings">Key Findings<a href="#key-findings" class="hash-link" aria-label="Direct link to Key Findings" title="Direct link to Key Findings" translate="no">​</a></h3>
<p><strong>Lazy pulling with eStargz provides dramatic startup improvements:</strong></p>
<ul>
<li><strong>150x faster pull times</strong> (9.2s → 0.06s)</li>
<li><strong>13.9x faster cold starts</strong> (9.4s → 0.67s)</li>
<li><strong>Zero disk storage overhead</strong></li>
</ul>
<p><strong>But reveals a critical trade-off for data-intensive workloads:</strong></p>
<ul>
<li><strong>1.5-2x slower total completion</strong> when accessing &gt;30% of image data</li>
<li>Stress test (8GB sequential read): Overlayfs 45-54s vs Stargz 79-88s</li>
<li><strong>Working set size determines which approach is faster</strong></li>
</ul>
<p><strong>Bottom line:</strong> Lazy pulling optimizes for startup latency (ideal for inference/serving), while eager loading optimizes for total completion time (better for training/batch processing).</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="key-results">Key Results<a href="#key-results" class="hash-link" aria-label="Direct link to Key Results" title="Direct link to Key Results" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cold-start-performance-small-working-set---2gb-image">Cold Start Performance (Small Working Set - 2GB Image)<a href="#cold-start-performance-small-working-set---2gb-image" class="hash-link" aria-label="Direct link to Cold Start Performance (Small Working Set - 2GB Image)" title="Direct link to Cold Start Performance (Small Working Set - 2GB Image)" translate="no">​</a></h3>
<table><thead><tr><th>Metric</th><th>Regular Pull</th><th>Lazy Pull (eStargz)</th><th>Improvement</th></tr></thead><tbody><tr><td><strong>Pull time</strong></td><td>9.178s</td><td>0.061s</td><td><strong>150x faster</strong></td></tr><tr><td><strong>Container start + ready</strong></td><td>199ms</td><td>587ms</td><td>Slower (on-demand fetch)</td></tr><tr><td><strong>Total cold start</strong></td><td>9.401s</td><td>0.675s</td><td><strong>13.9x faster</strong></td></tr><tr><td><strong>Data downloaded at pull</strong></td><td>2.0 GB</td><td>~9 KB</td><td><strong>99.9% reduction</strong></td></tr><tr><td><strong>Disk usage after pull</strong></td><td>2.0 GB cached</td><td>0 bytes</td><td><strong>100% savings</strong></td></tr></tbody></table>
<p><strong>Scenario</strong>: Application with small working set (~1-5% of image accessed)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="total-workload-completion-large-working-set---8gb-image-️">Total Workload Completion (Large Working Set - 8GB Image) ⚠️<a href="#total-workload-completion-large-working-set---8gb-image-️" class="hash-link" aria-label="Direct link to Total Workload Completion (Large Working Set - 8GB Image) ⚠️" title="Direct link to Total Workload Completion (Large Working Set - 8GB Image) ⚠️" translate="no">​</a></h3>
<p><strong>CRITICAL TRADE-OFF</strong>: When workloads access significant portions of the image, lazy pulling is <strong>SLOWER</strong> for total completion time.</p>
<p><strong>Stress Test Results</strong> (sequential read of 8GB data):</p>
<table><thead><tr><th>Mode</th><th>Registry</th><th>File Pattern</th><th>Total Time</th><th>vs Overlayfs</th></tr></thead><tbody><tr><td><strong>Overlayfs</strong></td><td>localhost</td><td>many-small</td><td>52s</td><td>baseline</td></tr><tr><td><strong>Overlayfs</strong></td><td>localhost</td><td>few-large</td><td>54s</td><td>baseline</td></tr><tr><td><strong>Overlayfs</strong></td><td>172.17.0.2</td><td>many-small</td><td>45s</td><td>baseline</td></tr><tr><td><strong>Overlayfs</strong></td><td>172.17.0.2</td><td>few-large</td><td>45s</td><td>baseline</td></tr><tr><td><strong>Stargz</strong></td><td>localhost</td><td>many-small</td><td><strong>88s</strong></td><td><strong>1.7x slower</strong> ❌</td></tr><tr><td><strong>Stargz</strong></td><td>localhost</td><td>few-large</td><td><strong>79s</strong></td><td><strong>1.5x slower</strong> ❌</td></tr><tr><td><strong>Stargz</strong></td><td>172.17.0.2</td><td>many-small</td><td><strong>82s</strong></td><td><strong>1.8x slower</strong> ❌</td></tr><tr><td><strong>Stargz</strong></td><td>172.17.0.2</td><td>few-large</td><td><strong>83s</strong></td><td><strong>1.8x slower</strong> ❌</td></tr></tbody></table>
<p><strong>Why Lazy Pulling is Slower for Data-Intensive Workloads:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Overlayfs (eager loading):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Bulk download: 45-53s (parallel, full bandwidth)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Workload execution: Fast (all data local on SSD)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ────────────────────────────────────</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Total: 45-54s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Stargz (lazy loading):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Metadata pull: &amp;lt;1s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Workload execution: 78-87s (many serialized HTTP range requests)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ────────────────────────────────────</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Total: 79-88s (1.5-2x SLOWER!)</span><br></span></code></pre></div></div>
<p><strong>Performance Breakdown:</strong></p>
<ul>
<li><strong>Pull phase</strong>: Stargz wins (150x faster) ✅</li>
<li><strong>Execution phase</strong>: Overlayfs wins (on-demand HTTP requests slower than local disk) ✅</li>
<li><strong>Total time</strong>: Depends on working set size and access pattern</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="key-insights">Key Insights<a href="#key-insights" class="hash-link" aria-label="Direct link to Key Insights" title="Direct link to Key Insights" translate="no">​</a></h3>
<ol>
<li>
<p><strong>Cold start time ≠ Total completion time</strong></p>
<ul>
<li>Lazy pulling optimizes startup latency</li>
<li>BUT penalizes total workload completion when data access is substantial</li>
</ul>
</li>
<li>
<p><strong>Working set size is critical</strong></p>
<ul>
<li>Small working set (&lt;10%): Lazy pulling wins dramatically (13.9x faster)</li>
<li>Large working set (&gt;30%): Eager loading wins (1.5-2x faster)</li>
</ul>
</li>
<li>
<p><strong>File pattern sensitivity</strong></p>
<ul>
<li>Many small files: Worse for lazy pulling (88s vs 79s)</li>
<li>Each file = separate HTTP request = more latency overhead</li>
</ul>
</li>
<li>
<p><strong>Network vs disk I/O trade-off</strong></p>
<ul>
<li>Bulk parallel download: ~45-53s for 8GB</li>
<li>Serialized on-demand fetches: ~78-87s for same data</li>
<li>Local disk reads &gt;&gt; HTTP range requests for large data access</li>
</ul>
</li>
</ol>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="technical-architecture">Technical Architecture<a href="#technical-architecture" class="hash-link" aria-label="Direct link to Technical Architecture" title="Direct link to Technical Architecture" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="core-components">Core Components<a href="#core-components" class="hash-link" aria-label="Direct link to Core Components" title="Direct link to Core Components" translate="no">​</a></h3>
<ol>
<li>
<p><strong>Containerd Benchmark Framework</strong> (<code>containerd-bench/</code>)</p>
<ul>
<li>Pure Go API integration with containerd</li>
<li>Programmatic control over container lifecycle</li>
<li>JSON Lines logging for performance analysis</li>
<li>Operations: PullImage, RPullImage (lazy), CreateContainer, StartContainer, etc.</li>
</ul>
</li>
<li>
<p><strong>Lazy Pulling with eStargz</strong></p>
<ul>
<li>Uses stargz-snapshotter plugin for on-demand layer fetching</li>
<li>HTTP range requests to fetch only needed chunks</li>
<li>FUSE filesystem for transparent lazy loading</li>
<li>Zero disk storage overhead</li>
</ul>
</li>
<li>
<p><strong>Startup Benchmarking Tool</strong> (<code>startup-bench/</code>)</p>
<ul>
<li>Cold and warm start measurements</li>
<li>Container readiness detection (not just process start)</li>
<li>Auto-detection of eStargz images by <code>:esgz</code> suffix</li>
<li>Support for plain HTTP registries</li>
</ul>
</li>
</ol>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-lazy-pulling-works">How Lazy Pulling Works<a href="#how-lazy-pulling-works" class="hash-link" aria-label="Direct link to How Lazy Pulling Works" title="Direct link to How Lazy Pulling Works" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="phase-1-metadata-fetch-006s-for-2gb-image">Phase 1: Metadata Fetch (~0.06s for 2GB image)<a href="#phase-1-metadata-fetch-006s-for-2gb-image" class="hash-link" aria-label="Direct link to Phase 1: Metadata Fetch (~0.06s for 2GB image)" title="Direct link to Phase 1: Metadata Fetch (~0.06s for 2GB image)" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Download index (290B) + manifest (2.6KB) + config (6.3KB) = ~9KB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Register layers with stargz-snapshotter as &quot;remote&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="phase-2-container-creation-003s">Phase 2: Container Creation (~0.03s)<a href="#phase-2-container-creation-003s" class="hash-link" aria-label="Direct link to Phase 2: Container Creation (~0.03s)" title="Direct link to Phase 2: Container Creation (~0.03s)" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Stargz-snapshotter creates remote snapshot mounts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FUSE filesystem presents layer contents virtually</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Container starts WITHOUT waiting for layer downloads</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="phase-3-on-demand-fetching-during-container-runtime">Phase 3: On-Demand Fetching (during container runtime)<a href="#phase-3-on-demand-fetching-during-container-runtime" class="hash-link" aria-label="Direct link to Phase 3: On-Demand Fetching (during container runtime)" title="Direct link to Phase 3: On-Demand Fetching (during container runtime)" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Application reads /app/data/file.dat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FUSE intercepts read()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP GET with Range: bytes=1024-2048 to registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Data returned (cached in memory, NOT disk)</span><br></span></code></pre></div></div>
<p><strong>Result</strong>: For 2GB image with small working set (~20-30MB accessed), only those chunks are fetched.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="performance-implications">Performance Implications<a href="#performance-implications" class="hash-link" aria-label="Direct link to Performance Implications" title="Direct link to Performance Implications" translate="no">​</a></h3>
<p><strong>Small Working Set (&lt;10% of image):</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Pull: &amp;lt;1s (metadata only)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Runtime: Fast (few on-demand fetches)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total: 13.9x faster than eager loading ✅</span><br></span></code></pre></div></div>
<p><strong>Large Working Set (&gt;30% of image):</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Pull: &amp;lt;1s (metadata only)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Runtime: 78-87s (many serialized HTTP requests)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total: 1.5-2x SLOWER than eager loading ❌</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Why slower:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Bulk parallel download: 45-53s for 8GB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- On-demand serial fetches: 78-87s for same 8GB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Each file access = network round-trip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- FUSE overhead + HTTP request overhead</span><br></span></code></pre></div></div>
<p><strong>Trade-off:</strong> Fast startup vs total completion time depends on working set size.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-highlights">Implementation Highlights<a href="#implementation-highlights" class="hash-link" aria-label="Direct link to Implementation Highlights" title="Direct link to Implementation Highlights" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rpullimage-operation">RPullImage Operation<a href="#rpullimage-operation" class="hash-link" aria-label="Direct link to RPullImage Operation" title="Direct link to RPullImage Operation" translate="no">​</a></h3>
<p>Used <code>source.AppendDefaultLabelsHandlerWrapper()</code> from stargz-snapshotter:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/containerd/containerd/v2/client&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/containerd/stargz-snapshotter/fs/source&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Create label handler - this enables lazy pulling!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">labelHandler </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AppendDefaultLabelsHandlerWrapper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">imageRef</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prefetchSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pullOpts </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RemoteOpt</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WithPullUnpack</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithImageHandlerWrapper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">labelHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Essential for lazy pulling</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithPullSnapshotter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;stargz&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> containerdClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Pull</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> imageRef</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pullOpts</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Critical Insight</strong>: Regular <code>containerd.Pull()</code> downloads everything even with stargz snapshotter. The label handler wrapper is <strong>essential</strong> for true lazy pulling.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="critical-bugs-discovered--fixed">Critical Bugs Discovered &amp; Fixed<a href="#critical-bugs-discovered--fixed" class="hash-link" aria-label="Direct link to Critical Bugs Discovered &amp; Fixed" title="Direct link to Critical Bugs Discovered &amp; Fixed" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-content-blob-caching">1. Content Blob Caching<a href="#1-content-blob-caching" class="hash-link" aria-label="Direct link to 1. Content Blob Caching" title="Direct link to 1. Content Blob Caching" translate="no">​</a></h3>
<p><strong>Problem</strong>: Cold start iterations reused cached content blobs (48s → 0.17s on iteration 2).</p>
<p><strong>Root Cause</strong>: Content blobs are globally shared across namespaces. Image removal only cleared metadata.</p>
<p><strong>Solution</strong>: Use <code>images.SynchronousDelete()</code> to trigger immediate garbage collection:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">deleteOpts </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">images</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DeleteOpt</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">images</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SynchronousDelete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> imageRef</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> deleteOpts</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-metadata-corruption">2. Metadata Corruption<a href="#2-metadata-corruption" class="hash-link" aria-label="Direct link to 2. Metadata Corruption" title="Direct link to 2. Metadata Corruption" translate="no">​</a></h3>
<p><strong>Problem</strong>: Mixing regular <code>Pull()</code> and <code>rpull</code> caused &quot;target snapshot already exists&quot; errors.</p>
<p><strong>Root Cause</strong>: Content blobs retained <code>containerd.io/uncompressed</code> annotations from previous pulls.</p>
<p><strong>Solution</strong>: Clean content store before lazy pulling:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo ctr-remote content ls | grep workload | awk &#x27;{print $1}&#x27; | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  xargs -I {} sudo ctr-remote content rm {}</span><br></span></code></pre></div></div>
<p><strong>Prevention</strong>: Never mix pull methods - always use RPullImage for eStargz images.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-plain-http-registry-support">3. Plain HTTP Registry Support<a href="#3-plain-http-registry-support" class="hash-link" aria-label="Direct link to 3. Plain HTTP Registry Support" title="Direct link to 3. Plain HTTP Registry Support" translate="no">​</a></h3>
<p><strong>Problem</strong>: Custom Docker resolver breaks lazy pulling by forcing full downloads.</p>
<p><strong>Solution for RPullImage</strong>: Configure stargz-snapshotter daemon instead:</p>
<div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># /etc/containerd-stargz-grpc/config.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[[resolver.host.&quot;172.17.0.2:5000&quot;.mirrors]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">host = &quot;172.17.0.2:5000&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">insecure = true</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="estargz-format-verification">eStargz Format Verification<a href="#estargz-format-verification" class="hash-link" aria-label="Direct link to eStargz Format Verification" title="Direct link to eStargz Format Verification" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="key-characteristics">Key Characteristics<a href="#key-characteristics" class="hash-link" aria-label="Direct link to Key Characteristics" title="Direct link to Key Characteristics" translate="no">​</a></h3>
<p><strong>Media Type</strong>: <code>application/vnd.oci.image.layer.v1.tar+gzip</code> (same as regular gzip!)</p>
<p><strong>Distinguishing Features</strong>:</p>
<ol>
<li><strong>STARGZ footer</strong> in blob (verify with <code>xxd</code>)</li>
<li><strong>TOC digest annotation</strong>: <code>containerd.io/snapshot/stargz/toc.digest</code></li>
<li><strong>Uncompressed size annotation</strong>: <code>io.containers.estargz.uncompressed-size</code></li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="creating-estargz-images">Creating eStargz Images<a href="#creating-estargz-images" class="hash-link" aria-label="Direct link to Creating eStargz Images" title="Direct link to Creating eStargz Images" translate="no">​</a></h3>
<p>Use ctr-remote workflow (NOT docker buildx):</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 1. Build regular image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker buildx build -t localhost:5000/image:base --push .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 2. Pull to containerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo ctr-remote image pull localhost:5000/image:base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3. Optimize to eStargz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo ctr-remote image optimize --no-optimize --oci \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  localhost:5000/image:base localhost:5000/image:esgz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 4. Push eStargz image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo ctr-remote images push --plain-http localhost:5000/image:esgz</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verification">Verification<a href="#verification" class="hash-link" aria-label="Direct link to Verification" title="Direct link to Verification" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Check manifest annotations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -s http://localhost:5000/v2/image/manifests/esgz | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  jq &#x27;.layers[].annotations&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Verify STARGZ footer in blob</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo tail -c 100 /var/lib/containerd/.../blobs/sha256/... | xxd | tail -3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Look for: &quot;STARGZ&quot; marker</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="best-practices">Best Practices<a href="#best-practices" class="hash-link" aria-label="Direct link to Best Practices" title="Direct link to Best Practices" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="decision-framework-lazy-pulling-vs-eager-loading">Decision Framework: Lazy Pulling vs Eager Loading<a href="#decision-framework-lazy-pulling-vs-eager-loading" class="hash-link" aria-label="Direct link to Decision Framework: Lazy Pulling vs Eager Loading" title="Direct link to Decision Framework: Lazy Pulling vs Eager Loading" translate="no">​</a></h3>
<p><strong>The critical factor is WORKING SET SIZE:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Working Set &lt; 10% of image:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → Use lazy pulling (13.9x faster startup)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Working Set &gt; 30% of image:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → Use eager loading (1.5-2x faster total completion)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Working Set 10-30% of image:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → Depends on whether you optimize for startup or total time</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-lazy-pulling-">When to Use Lazy Pulling ✅<a href="#when-to-use-lazy-pulling-" class="hash-link" aria-label="Direct link to When to Use Lazy Pulling ✅" title="Direct link to When to Use Lazy Pulling ✅" translate="no">​</a></h3>
<p><strong>Best for startup latency optimization:</strong></p>
<ol>
<li>
<p><strong>Small working set</strong> (&lt;10% of image accessed)</p>
<ul>
<li>Example: Web API loading libraries (100MB of 2GB image)</li>
<li>Result: 13.9x faster cold start</li>
</ul>
</li>
<li>
<p><strong>Ephemeral workloads</strong> - short-lived containers</p>
<ul>
<li>Containers that start, perform task, exit quickly</li>
<li>Don&#x27;t benefit from caching anyway</li>
</ul>
</li>
<li>
<p><strong>Cold start critical</strong> - startup time is the bottleneck</p>
<ul>
<li>Serverless functions</li>
<li>Auto-scaling scenarios</li>
<li>Development/testing iterations</li>
</ul>
</li>
<li>
<p><strong>Limited disk space</strong> - can&#x27;t cache full images</p>
<ul>
<li>Edge devices</li>
<li>Multi-tenant nodes with many images</li>
</ul>
</li>
<li>
<p><strong>High bandwidth, low latency</strong> to registry</p>
<ul>
<li>On-demand fetches need fast network</li>
<li>Registry co-located with compute</li>
</ul>
</li>
</ol>
<p><strong>Example Use Case:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LLM Inference API:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Image: 4GB (model weights)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Working set: 300MB (actively loaded model portion)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Access pattern: Load once, serve many requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lazy pulling: 1-2s startup vs 18s eager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Result: 9-18x faster! ✅</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="when-not-to-use-lazy-pulling-">When NOT to Use Lazy Pulling ❌<a href="#when-not-to-use-lazy-pulling-" class="hash-link" aria-label="Direct link to When NOT to Use Lazy Pulling ❌" title="Direct link to When NOT to Use Lazy Pulling ❌" translate="no">​</a></h3>
<p><strong>Eager loading is faster when:</strong></p>
<ol>
<li>
<p><strong>Large working set</strong> (&gt;30% of image accessed)</p>
<ul>
<li>Example: Batch processing reading 8GB of 8GB image</li>
<li>Result: Lazy pulling 1.5-2x SLOWER for total completion</li>
</ul>
</li>
<li>
<p><strong>Data-intensive workloads</strong> - process significant data</p>
<ul>
<li>Training jobs accessing entire dataset</li>
<li>ETL pipelines reading many files</li>
<li>Stress tests (like our benchmark)</li>
</ul>
</li>
<li>
<p><strong>Sequential file access</strong> - many files read in order</p>
<ul>
<li>Each file = separate HTTP request with lazy pulling</li>
<li>Bulk download is much faster (parallel, large chunks)</li>
</ul>
</li>
<li>
<p><strong>Small images</strong> (&lt;100MB) - overhead not worth it</p>
<ul>
<li>Metadata overhead dominates</li>
</ul>
</li>
<li>
<p><strong>Slow/high-latency network</strong> - on-demand fetches will be slow</p>
<ul>
<li>Each file access waits for network round-trip</li>
</ul>
</li>
<li>
<p><strong>Offline/air-gapped environments</strong> - no registry access</p>
</li>
</ol>
<p><strong>Example Use Case:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LLM Training/Fine-tuning:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Image: 8GB (dataset + checkpoints)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Working set: 7GB (accessing most data during training)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Access pattern: Read many files sequentially</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lazy pulling: 79-88s total time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Eager loading: 45-54s total time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Result: Eager 1.5-2x faster! ✅</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="performance-optimization-matrix">Performance Optimization Matrix<a href="#performance-optimization-matrix" class="hash-link" aria-label="Direct link to Performance Optimization Matrix" title="Direct link to Performance Optimization Matrix" translate="no">​</a></h3>
<table><thead><tr><th>Metric to Optimize</th><th>Image Size</th><th>Working Set</th><th>Recommendation</th></tr></thead><tbody><tr><td><strong>Cold start time</strong></td><td>Large (&gt;1GB)</td><td>Small (&lt;10%)</td><td>Lazy pulling ✅</td></tr><tr><td><strong>Cold start time</strong></td><td>Large (&gt;1GB)</td><td>Large (&gt;30%)</td><td>Lazy pulling ✅ (startup only)</td></tr><tr><td><strong>Total completion time</strong></td><td>Large (&gt;1GB)</td><td>Small (&lt;10%)</td><td>Lazy pulling ✅</td></tr><tr><td><strong>Total completion time</strong></td><td>Large (&gt;1GB)</td><td>Large (&gt;30%)</td><td>Eager loading ✅</td></tr><tr><td><strong>Disk usage</strong></td><td>Any</td><td>Any</td><td>Lazy pulling ✅</td></tr><tr><td><strong>Network bandwidth</strong></td><td>Large (&gt;1GB)</td><td>Small (&lt;10%)</td><td>Lazy pulling ✅</td></tr><tr><td><strong>Network bandwidth</strong></td><td>Large (&gt;1GB)</td><td>Large (&gt;30%)</td><td>Eager loading ✅</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="architecture-insights">Architecture Insights<a href="#architecture-insights" class="hash-link" aria-label="Direct link to Architecture Insights" title="Direct link to Architecture Insights" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="containerd-design-principles">Containerd Design Principles<a href="#containerd-design-principles" class="hash-link" aria-label="Direct link to Containerd Design Principles" title="Direct link to Containerd Design Principles" translate="no">​</a></h3>
<ol>
<li>
<p><strong>Content Store is Global</strong></p>
<ul>
<li>Image metadata: namespaced ✅</li>
<li>Container metadata: namespaced ✅</li>
<li>Content blobs: <strong>GLOBAL</strong> (shared across namespaces) ❌</li>
</ul>
</li>
<li>
<p><strong>Snapshotter Abstraction</strong></p>
<ul>
<li>Each snapshotter has unique requirements</li>
<li>Stargz needs special label handlers for lazy pulling</li>
<li>Not as simple as just switching a snapshotter flag</li>
</ul>
</li>
<li>
<p><strong>Trade-offs</strong></p>
<ul>
<li><strong>Startup latency</strong>: Lazy pulling dramatically faster (13.9x)</li>
<li><strong>Total completion</strong>: Depends on working set size<!-- -->
<ul>
<li>Small working set (&lt;10%): Lazy pulling wins (13.9x faster)</li>
<li>Large working set (&gt;30%): Eager loading wins (1.5-2x faster)</li>
</ul>
</li>
<li><strong>Network vs Disk I/O</strong>:<!-- -->
<ul>
<li>Bulk parallel download: ~45-53s for 8GB</li>
<li>Serialized on-demand fetches: ~78-87s for same 8GB data</li>
<li>Local disk reads &gt;&gt; HTTP range requests for large data access</li>
</ul>
</li>
<li><strong>Zero storage overhead</strong> vs traditional caching benefits</li>
<li><strong>Network-dependent performance</strong> - requires good bandwidth/latency</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="version-compatibility">Version Compatibility<a href="#version-compatibility" class="hash-link" aria-label="Direct link to Version Compatibility" title="Direct link to Version Compatibility" translate="no">​</a></h3>
<p><strong>Critical</strong>: Match library versions with system installations</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Check system version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">containerd --version  # v2.1.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Use matching library version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go get github.com/containerd/containerd/v2@v2.1.4</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="debugging-techniques">Debugging Techniques<a href="#debugging-techniques" class="hash-link" aria-label="Direct link to Debugging Techniques" title="Direct link to Debugging Techniques" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-check-content-store-annotations">1. Check Content Store Annotations<a href="#1-check-content-store-annotations" class="hash-link" aria-label="Direct link to 1. Check Content Store Annotations" title="Direct link to 1. Check Content Store Annotations" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo ctr-remote content ls | grep image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Look for: containerd.io/uncompressed annotations</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-verify-lazy-pulling-is-active">2. Verify Lazy Pulling is Active<a href="#2-verify-lazy-pulling-is-active" class="hash-link" aria-label="Direct link to 2. Verify Lazy Pulling is Active" title="Direct link to 2. Verify Lazy Pulling is Active" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Inside container, check for stargz metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ls /.stargz-snapshotter/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat /.stargz-snapshotter/*.json</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-binary-verification">3. Binary Verification<a href="#3-binary-verification" class="hash-link" aria-label="Direct link to 3. Binary Verification" title="Direct link to 3. Binary Verification" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Check STARGZ footer (authoritative proof)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo tail -c 100 /var/lib/containerd/.../blobs/sha256/... | xxd | tail -3</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-monitor-on-demand-fetches">4. Monitor On-Demand Fetches<a href="#4-monitor-on-demand-fetches" class="hash-link" aria-label="Direct link to 4. Monitor On-Demand Fetches" title="Direct link to 4. Monitor On-Demand Fetches" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Watch stargz-snapshotter logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo journalctl -u stargz-snapshotter -f</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="quick-reference-commands">Quick Reference Commands<a href="#quick-reference-commands" class="hash-link" aria-label="Direct link to Quick Reference Commands" title="Direct link to Quick Reference Commands" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="setup">Setup<a href="#setup" class="hash-link" aria-label="Direct link to Setup" title="Direct link to Setup" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Start local registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -d --name registry -p 5000:5000 registry:2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Start stargz-snapshotter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl start stargz-snapshotter</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="benchmarking">Benchmarking<a href="#benchmarking" class="hash-link" aria-label="Direct link to Benchmarking" title="Direct link to Benchmarking" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Build tool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd startup-bench &amp;&amp; go build -o startup-bench main.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cold start with lazy pulling (auto-detected via :esgz suffix)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo ./startup-bench \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -image=localhost:5000/workload-2048mb-few-large:esgz \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -snapshotter=stargz \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -mode=cold \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -iterations=3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cold start with regular pull</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo ./startup-bench \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -image=localhost:5000/workload-2048mb-few-large:latest \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -snapshotter=overlayfs \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -mode=cold \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -iterations=3</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cleanup">Cleanup<a href="#cleanup" class="hash-link" aria-label="Direct link to Cleanup" title="Direct link to Cleanup" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Clean content store for true cold starts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo ctr-remote content ls | grep workload | awk &#x27;{print $1}&#x27; | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  xargs -I {} sudo ctr-remote content rm {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Restart services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl restart stargz-snapshotter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl restart containerd</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="external-resources">External Resources<a href="#external-resources" class="hash-link" aria-label="Direct link to External Resources" title="Direct link to External Resources" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="official-documentation">Official Documentation<a href="#official-documentation" class="hash-link" aria-label="Direct link to Official Documentation" title="Direct link to Official Documentation" translate="no">​</a></h3>
<p><strong>Stargz-Snapshotter</strong>:</p>
<ul>
<li><a href="https://github.com/containerd/stargz-snapshotter/blob/main/docs/overview.md" target="_blank" rel="noopener noreferrer">Project Overview</a></li>
<li><a href="https://github.com/containerd/stargz-snapshotter/blob/main/docs/getting-started.md" target="_blank" rel="noopener noreferrer">Getting Started Guide</a></li>
<li><a href="https://github.com/containerd/stargz-snapshotter/blob/main/docs/ctr-remote.md" target="_blank" rel="noopener noreferrer">ctr-remote CLI Tool</a></li>
<li><a href="https://github.com/containerd/stargz-snapshotter/blob/main/docs/overview.md#registry-mirrors-and-insecure-connection" target="_blank" rel="noopener noreferrer">Registry Configuration</a></li>
<li><a href="https://github.com/containerd/stargz-snapshotter" target="_blank" rel="noopener noreferrer">GitHub Repository</a></li>
</ul>
<p><strong>Containerd</strong>:</p>
<ul>
<li><a href="https://github.com/containerd/containerd/tree/main/docs" target="_blank" rel="noopener noreferrer">Official Documentation</a></li>
<li><a href="https://github.com/containerd/containerd/blob/main/docs/garbage-collection.md" target="_blank" rel="noopener noreferrer">Garbage Collection</a></li>
<li><a href="https://github.com/containerd/containerd/blob/main/docs/content-flow.md" target="_blank" rel="noopener noreferrer">Content Store Design</a></li>
<li><a href="https://github.com/containerd/containerd/blob/main/docs/namespaces.md" target="_blank" rel="noopener noreferrer">Namespaces</a></li>
<li><a href="https://github.com/containerd/containerd/blob/main/docs/snapshotters/README.md" target="_blank" rel="noopener noreferrer">Snapshotters</a></li>
<li><a href="https://github.com/containerd/containerd" target="_blank" rel="noopener noreferrer">GitHub Repository</a></li>
</ul>
<p><strong>OCI Specifications</strong>:</p>
<ul>
<li><a href="https://github.com/opencontainers/image-spec" target="_blank" rel="noopener noreferrer">OCI Image Spec</a></li>
<li><a href="https://github.com/opencontainers/image-spec/blob/main/media-types.md" target="_blank" rel="noopener noreferrer">Media Types</a></li>
<li><a href="https://github.com/opencontainers/image-spec/blob/main/layer.md" target="_blank" rel="noopener noreferrer">Image Layer Spec</a></li>
</ul>
<p><strong>eStargz Format</strong>:</p>
<ul>
<li><a href="https://github.com/containerd/stargz-snapshotter/blob/main/docs/estargz.md" target="_blank" rel="noopener noreferrer">eStargz Paper</a></li>
<li><a href="https://github.com/containerd/stargz-snapshotter/blob/main/docs/stargz-estargz.md" target="_blank" rel="noopener noreferrer">Format Specification</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="related-tools--projects">Related Tools &amp; Projects<a href="#related-tools--projects" class="hash-link" aria-label="Direct link to Related Tools &amp; Projects" title="Direct link to Related Tools &amp; Projects" translate="no">​</a></h3>
<p><strong>Container Runtimes</strong>:</p>
<ul>
<li><a href="https://containerd.io/" target="_blank" rel="noopener noreferrer">containerd</a> - Industry-standard container runtime</li>
<li><a href="https://github.com/opencontainers/runc" target="_blank" rel="noopener noreferrer">runc</a> - OCI container runtime</li>
</ul>
<p><strong>Image Optimization</strong>:</p>
<ul>
<li><a href="https://github.com/moby/buildkit" target="_blank" rel="noopener noreferrer">Buildkit</a> - Concurrent, cache-efficient build toolkit</li>
<li><a href="https://github.com/dragonflyoss/nydus" target="_blank" rel="noopener noreferrer">Nydus</a> - Alternative lazy-pulling solution by Dragonfly</li>
</ul>
<p><strong>Registries</strong>:</p>
<ul>
<li><a href="https://docs.docker.com/registry/" target="_blank" rel="noopener noreferrer">Docker Registry</a> - Open-source registry implementation</li>
<li><a href="https://github.com/opencontainers/distribution-spec" target="_blank" rel="noopener noreferrer">Distribution Spec</a> - OCI distribution specification</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="research-papers--articles">Research Papers &amp; Articles<a href="#research-papers--articles" class="hash-link" aria-label="Direct link to Research Papers &amp; Articles" title="Direct link to Research Papers &amp; Articles" translate="no">​</a></h3>
<p><strong>Lazy Pulling &amp; Container Startup</strong>:</p>
<ul>
<li><a href="https://www.usenix.org/conference/fast20/presentation/li" target="_blank" rel="noopener noreferrer">FAST &#x27;20: Startup Containers in Lightning Speed with Lazy Image Distribution</a></li>
<li><a href="https://www.usenix.org/conference/fast16/technical-sessions/presentation/harter" target="_blank" rel="noopener noreferrer">Slacker: Fast Distribution with Lazy Docker Containers</a></li>
</ul>
<p><strong>Container Image Optimization</strong>:</p>
<ul>
<li><a href="https://www.usenix.org/conference/atc19/presentation/zhao-jian" target="_blank" rel="noopener noreferrer">USENIX ATC &#x27;19: Packer: Toward Million-fold Container Image Optimization</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="community--support">Community &amp; Support<a href="#community--support" class="hash-link" aria-label="Direct link to Community &amp; Support" title="Direct link to Community &amp; Support" translate="no">​</a></h3>
<p><strong>Issue Trackers</strong>:</p>
<ul>
<li><a href="https://github.com/containerd/stargz-snapshotter/issues" target="_blank" rel="noopener noreferrer">Stargz-Snapshotter Issues</a></li>
<li><a href="https://github.com/containerd/containerd/issues" target="_blank" rel="noopener noreferrer">Containerd Issues</a></li>
<li><a href="https://github.com/dragonflyoss/nydus/issues/1527" target="_blank" rel="noopener noreferrer">Nydus Lazy Pulling Issue #1527</a> - Related metadata corruption</li>
</ul>
<p><strong>Communication</strong>:</p>
<ul>
<li><a href="https://slack.containerd.io/" target="_blank" rel="noopener noreferrer">Containerd Slack</a> - Community chat</li>
<li><a href="https://cloud-native.slack.com/messages/containerd" target="_blank" rel="noopener noreferrer">CNCF Slack #containerd</a> - Technical discussions</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tutorials--guides">Tutorials &amp; Guides<a href="#tutorials--guides" class="hash-link" aria-label="Direct link to Tutorials &amp; Guides" title="Direct link to Tutorials &amp; Guides" translate="no">​</a></h3>
<p><strong>Getting Started</strong>:</p>
<ul>
<li><a href="https://containerd.io/docs/getting-started/" target="_blank" rel="noopener noreferrer">Containerd Getting Started</a></li>
<li><a href="https://github.com/containerd/stargz-snapshotter/blob/main/docs/getting-started.md" target="_blank" rel="noopener noreferrer">Stargz-Snapshotter Quick Start</a></li>
</ul>
<p><strong>Advanced Topics</strong>:</p>
<ul>
<li><a href="https://github.com/containerd/stargz-snapshotter/blob/main/docs/overview.md#lazy-pulling-feature" target="_blank" rel="noopener noreferrer">Lazy Pulling Deep Dive</a></li>
<li><a href="https://github.com/containerd/stargz-snapshotter/blob/main/docs/ctr-remote.md#building-estargz" target="_blank" rel="noopener noreferrer">Building eStargz Images</a></li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="key-takeaways">Key Takeaways<a href="#key-takeaways" class="hash-link" aria-label="Direct link to Key Takeaways" title="Direct link to Key Takeaways" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="technical-insights">Technical Insights<a href="#technical-insights" class="hash-link" aria-label="Direct link to Technical Insights" title="Direct link to Technical Insights" translate="no">​</a></h3>
<ol>
<li><strong>Lazy pulling is essential for large images</strong> - 150x pull speedup for 2GB images</li>
<li><strong>Label handlers are critical</strong> - Regular containerd.Pull() doesn&#x27;t enable lazy pulling</li>
<li><strong>Content store is global</strong> - Shared across namespaces, requires explicit cleanup</li>
<li><strong>Never mix pull methods</strong> - Causes metadata corruption</li>
<li><strong>eStargz verification</strong> - Check STARGZ footer in blobs, not just media type</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="performance-characteristics">Performance Characteristics<a href="#performance-characteristics" class="hash-link" aria-label="Direct link to Performance Characteristics" title="Direct link to Performance Characteristics" translate="no">​</a></h3>
<ol>
<li><strong>Speedup scales with image size</strong> - Larger images benefit more</li>
<li><strong>Network-dependent</strong> - Requires good bandwidth/latency to registry</li>
<li><strong>Working set matters</strong> - Only fetches accessed files</li>
<li><strong>Trade-off exists</strong> - Faster pull, slightly slower start</li>
<li><strong>Zero storage overhead</strong> - No disk caching of full layers</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="development-best-practices">Development Best Practices<a href="#development-best-practices" class="hash-link" aria-label="Direct link to Development Best Practices" title="Direct link to Development Best Practices" translate="no">​</a></h3>
<ol>
<li><strong>Performance-driven debugging</strong> - Timing anomalies reveal bugs</li>
<li><strong>Binary-level verification</strong> - Source of truth for format validation</li>
<li><strong>Read upstream source code</strong> - Reveals exact implementation details</li>
<li><strong>Test with realistic workloads</strong> - Small images don&#x27;t show benefits</li>
<li><strong>Match system versions</strong> - Library versions should align with binaries</li>
</ol>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate="no">​</a></h2>
<p>This project demonstrates that <strong>eStargz with lazy pulling provides dramatic performance improvements for startup latency</strong>, but reveals a <strong>critical trade-off with total workload completion time</strong> that depends on working set size.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="key-findings-1">Key Findings<a href="#key-findings-1" class="hash-link" aria-label="Direct link to Key Findings" title="Direct link to Key Findings" translate="no">​</a></h3>
<p><strong>✅ Lazy Pulling Wins for Startup Latency:</strong></p>
<ul>
<li>150x faster pull time (9.2s → 0.06s)</li>
<li>13.9x faster cold start (9.4s → 0.67s)</li>
<li>Zero disk storage overhead</li>
<li>Ideal for small working sets (&lt;10% of image)</li>
</ul>
<p><strong>⚠️ Eager Loading Wins for Data-Intensive Workloads:</strong></p>
<ul>
<li>1.5-2x faster total completion for large working sets (&gt;30% of image)</li>
<li>Bulk parallel downloads faster than serialized on-demand fetches</li>
<li>Better for batch processing, training, ETL pipelines</li>
<li>Stress test (8GB sequential read): Overlayfs 45-54s vs Stargz 79-88s</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="decision-framework">Decision Framework<a href="#decision-framework" class="hash-link" aria-label="Direct link to Decision Framework" title="Direct link to Decision Framework" translate="no">​</a></h3>
<p><strong>The critical question: What percentage of your image does the workload access?</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Small working set (&amp;lt;10%):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → Lazy pulling essential (13.9x faster)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → Example: LLM inference API loading 300MB of 4GB image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Large working set (&gt;30%):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → Eager loading faster (1.5-2x faster total time)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → Example: Training job accessing 7GB of 8GB image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Optimize for startup time:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → Always use lazy pulling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Optimize for total completion time:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → Use lazy pulling only for small working sets</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="production-recommendations">Production Recommendations<a href="#production-recommendations" class="hash-link" aria-label="Direct link to Production Recommendations" title="Direct link to Production Recommendations" translate="no">​</a></h3>
<ol>
<li>
<p><strong>LLM Inference/Serving</strong> - Use lazy pulling ✅</p>
<ul>
<li>Small working set, startup critical</li>
<li>10-20x faster cold start for auto-scaling</li>
</ul>
</li>
<li>
<p><strong>LLM Training/Fine-tuning</strong> - Use eager loading ✅</p>
<ul>
<li>Large working set, total time matters</li>
<li>Avoid 1.5-2x penalty for on-demand fetches</li>
</ul>
</li>
<li>
<p><strong>Development/Testing</strong> - Use lazy pulling ✅</p>
<ul>
<li>Fast iteration cycles</li>
<li>Disk space savings</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="technical-validation">Technical Validation<a href="#technical-validation" class="hash-link" aria-label="Direct link to Technical Validation" title="Direct link to Technical Validation" translate="no">​</a></h3>
<p>The implementation validates that:</p>
<ul>
<li>Proper integration with stargz-snapshotter enables true lazy pulling</li>
<li>Label handlers (<code>AppendDefaultLabelsHandlerWrapper</code>) are essential</li>
<li>Content store management critical for accurate benchmarking</li>
<li>Working set size is the primary performance factor</li>
<li>Network vs disk I/O trade-off is significant for large data access</li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/learnings/2025-10-aman-week2"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">AI Video Cutter - Week 2 Learnings</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#key-findings" class="table-of-contents__link toc-highlight">Key Findings</a></li><li><a href="#key-results" class="table-of-contents__link toc-highlight">Key Results</a><ul><li><a href="#cold-start-performance-small-working-set---2gb-image" class="table-of-contents__link toc-highlight">Cold Start Performance (Small Working Set - 2GB Image)</a></li><li><a href="#total-workload-completion-large-working-set---8gb-image-️" class="table-of-contents__link toc-highlight">Total Workload Completion (Large Working Set - 8GB Image) ⚠️</a></li><li><a href="#key-insights" class="table-of-contents__link toc-highlight">Key Insights</a></li></ul></li><li><a href="#technical-architecture" class="table-of-contents__link toc-highlight">Technical Architecture</a><ul><li><a href="#core-components" class="table-of-contents__link toc-highlight">Core Components</a></li></ul></li><li><a href="#how-lazy-pulling-works" class="table-of-contents__link toc-highlight">How Lazy Pulling Works</a><ul><li><a href="#phase-1-metadata-fetch-006s-for-2gb-image" class="table-of-contents__link toc-highlight">Phase 1: Metadata Fetch (~0.06s for 2GB image)</a></li><li><a href="#phase-2-container-creation-003s" class="table-of-contents__link toc-highlight">Phase 2: Container Creation (~0.03s)</a></li><li><a href="#phase-3-on-demand-fetching-during-container-runtime" class="table-of-contents__link toc-highlight">Phase 3: On-Demand Fetching (during container runtime)</a></li><li><a href="#performance-implications" class="table-of-contents__link toc-highlight">Performance Implications</a></li></ul></li><li><a href="#implementation-highlights" class="table-of-contents__link toc-highlight">Implementation Highlights</a><ul><li><a href="#rpullimage-operation" class="table-of-contents__link toc-highlight">RPullImage Operation</a></li></ul></li><li><a href="#critical-bugs-discovered--fixed" class="table-of-contents__link toc-highlight">Critical Bugs Discovered &amp; Fixed</a><ul><li><a href="#1-content-blob-caching" class="table-of-contents__link toc-highlight">1. Content Blob Caching</a></li><li><a href="#2-metadata-corruption" class="table-of-contents__link toc-highlight">2. Metadata Corruption</a></li><li><a href="#3-plain-http-registry-support" class="table-of-contents__link toc-highlight">3. Plain HTTP Registry Support</a></li></ul></li><li><a href="#estargz-format-verification" class="table-of-contents__link toc-highlight">eStargz Format Verification</a><ul><li><a href="#key-characteristics" class="table-of-contents__link toc-highlight">Key Characteristics</a></li><li><a href="#creating-estargz-images" class="table-of-contents__link toc-highlight">Creating eStargz Images</a></li><li><a href="#verification" class="table-of-contents__link toc-highlight">Verification</a></li></ul></li><li><a href="#best-practices" class="table-of-contents__link toc-highlight">Best Practices</a><ul><li><a href="#decision-framework-lazy-pulling-vs-eager-loading" class="table-of-contents__link toc-highlight">Decision Framework: Lazy Pulling vs Eager Loading</a></li><li><a href="#when-to-use-lazy-pulling-" class="table-of-contents__link toc-highlight">When to Use Lazy Pulling ✅</a></li><li><a href="#when-not-to-use-lazy-pulling-" class="table-of-contents__link toc-highlight">When NOT to Use Lazy Pulling ❌</a></li><li><a href="#performance-optimization-matrix" class="table-of-contents__link toc-highlight">Performance Optimization Matrix</a></li></ul></li><li><a href="#architecture-insights" class="table-of-contents__link toc-highlight">Architecture Insights</a><ul><li><a href="#containerd-design-principles" class="table-of-contents__link toc-highlight">Containerd Design Principles</a></li><li><a href="#version-compatibility" class="table-of-contents__link toc-highlight">Version Compatibility</a></li></ul></li><li><a href="#debugging-techniques" class="table-of-contents__link toc-highlight">Debugging Techniques</a><ul><li><a href="#1-check-content-store-annotations" class="table-of-contents__link toc-highlight">1. Check Content Store Annotations</a></li><li><a href="#2-verify-lazy-pulling-is-active" class="table-of-contents__link toc-highlight">2. Verify Lazy Pulling is Active</a></li><li><a href="#3-binary-verification" class="table-of-contents__link toc-highlight">3. Binary Verification</a></li><li><a href="#4-monitor-on-demand-fetches" class="table-of-contents__link toc-highlight">4. Monitor On-Demand Fetches</a></li></ul></li><li><a href="#quick-reference-commands" class="table-of-contents__link toc-highlight">Quick Reference Commands</a><ul><li><a href="#setup" class="table-of-contents__link toc-highlight">Setup</a></li><li><a href="#benchmarking" class="table-of-contents__link toc-highlight">Benchmarking</a></li><li><a href="#cleanup" class="table-of-contents__link toc-highlight">Cleanup</a></li></ul></li><li><a href="#external-resources" class="table-of-contents__link toc-highlight">External Resources</a><ul><li><a href="#official-documentation" class="table-of-contents__link toc-highlight">Official Documentation</a></li><li><a href="#related-tools--projects" class="table-of-contents__link toc-highlight">Related Tools &amp; Projects</a></li><li><a href="#research-papers--articles" class="table-of-contents__link toc-highlight">Research Papers &amp; Articles</a></li><li><a href="#community--support" class="table-of-contents__link toc-highlight">Community &amp; Support</a></li><li><a href="#tutorials--guides" class="table-of-contents__link toc-highlight">Tutorials &amp; Guides</a></li></ul></li><li><a href="#key-takeaways" class="table-of-contents__link toc-highlight">Key Takeaways</a><ul><li><a href="#technical-insights" class="table-of-contents__link toc-highlight">Technical Insights</a></li><li><a href="#performance-characteristics" class="table-of-contents__link toc-highlight">Performance Characteristics</a></li><li><a href="#development-best-practices" class="table-of-contents__link toc-highlight">Development Best Practices</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a><ul><li><a href="#key-findings-1" class="table-of-contents__link toc-highlight">Key Findings</a></li><li><a href="#decision-framework" class="table-of-contents__link toc-highlight">Decision Framework</a></li><li><a href="#production-recommendations" class="table-of-contents__link toc-highlight">Production Recommendations</a></li><li><a href="#technical-validation" class="table-of-contents__link toc-highlight">Technical Validation</a></li></ul></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/vertexcover-io" target="_blank" rel="noopener noreferrer" class="footer__link-item footer-github-link" aria-label="GitHub repository">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Codeshelf, Inc.</div></div></div></footer></div>
</body>
</html>