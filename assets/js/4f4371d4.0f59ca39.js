"use strict";(self.webpackChunkblog_vertexcover=self.webpackChunkblog_vertexcover||[]).push([[938],{614:(e,t,c)=>{c.d(t,{A:()=>s});c(6540);var n=c(4848);function s({children:e}){return(0,n.jsxs)("div",{style:{backgroundColor:"#f8f9fa",border:"1px solid #dee2e6",borderRadius:"8px",padding:"16px",margin:"20px 0",borderLeft:"4px solid #007bff"},children:[(0,n.jsx)("strong",{style:{color:"#007bff",fontSize:"14px",textTransform:"uppercase",letterSpacing:"0.5px"},children:"TL;DR:"}),(0,n.jsx)("div",{style:{marginTop:"8px"},children:e})]})}},1188:(e,t,c)=>{c.r(t),c.d(t,{assets:()=>h,contentTitle:()=>a,default:()=>m,frontMatter:()=>l,metadata:()=>n,toc:()=>u});var n=c(5549),s=c(4848),r=c(8453),i=c(614),o=c(8700),d=c(8509);const l={slug:"speed-up-docker-builds-on-github-actions",title:"Speed up Docker Builds on Github actions",description:"Tricks to speed up docker builds",date:new Date("2025-08-20T00:00:00.000Z"),tags:[],draft:!1},a=void 0,h={authorsImageUrls:[]},u=[{value:"Why this matters",id:"why-this-matters",level:3},{value:"1. Turn on BuildKit &amp; Buildx everywhere",id:"1-turn-on-buildkit--buildx-everywhere",level:2},{value:"2. Trim the build context",id:"2-trim-the-build-context",level:2},{value:"3. Re-order your Dockerfile",id:"3-re-order-your-dockerfile",level:2},{value:"4. Choose the <em>right</em> layer-cache backend",id:"4-choose-the-right-layer-cache-backend",level:2},{value:"5. Cache-mounts + the \u201cBuildKit Cache Dance\u201d",id:"5-cache-mounts--the-buildkit-cache-dance",level:2},{value:"6. tmpfs + \u201cunsafe-io\u201d = &lt; 90 s package installs",id:"6-tmpfs--unsafe-io---90-s-package-installs",level:2},{value:"7. Other micro-wins",id:"7-other-micro-wins",level:2},{value:"References",id:"references",level:2}];function p(e){const t={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(i.A,{children:[(0,s.jsx)(o.A,{items:["Turn on BuildKit & Buildx everywhere","Reorder Dockerfile: copy package files first, then rest of code","Use cache-mounts with buildkit-cache-dance action","Pick the right cache backend (inline for speed, registry for large images)","Add tmpfs + unsafe-io flags for package installs"]}),(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"Scenario"}),(0,s.jsx)(t.th,{children:"Avg. wall-clock"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"No caching"}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.strong,{children:"1 h 10 m"})})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"Layer-cache hit"}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.strong,{children:"6 m"})})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"Layer-cache miss (deps change)"}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.strong,{children:"52 m"})})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"Cache-mount + Cache-Dance"}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.strong,{children:"8 m"})})]})]})]}),(0,s.jsx)(t.p,{children:"Stop rebuilding the world on every pull-request\u2014turn on these flags and ship faster."})]}),"\n","\n",(0,s.jsx)(t.h3,{id:"why-this-matters",children:"Why this matters"}),"\n",(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsx)(t.p,{children:"70 min \u279c 6 min (deps unchanged) or 8 min (deps changed)."}),"\n",(0,s.jsx)(t.p,{children:"Those are the real numbers we saw after switching our Node + Python monorepo to the techniques below."}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"Slow builds waste CI minutes, break focus, and block deploys."}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsx)(t.h2,{id:"1-turn-on-buildkit--buildx-everywhere",children:"1. Turn on BuildKit & Buildx everywhere"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-yaml",children:'# .github/workflows/build.yml\n- uses: docker/setup-buildx-action@v3   # spins up an isolated BuildKit builder\n- run: echo "DOCKER_BUILDKIT=1" >> $GITHUB_ENV\n\n'})}),"\n",(0,s.jsxs)(t.p,{children:["BuildKit unlocks layer caching, cache-mounts, ",(0,s.jsx)(t.code,{children:"RUN --mount"}),", and multi-platform bake. ",(0,s.jsx)(t.a,{href:"https://docs.docker.com/build/ci/github-actions/cache/?utm_source=chatgpt.com",children:"Docker Documentation"})]}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsx)(t.h2,{id:"2-trim-the-build-context",children:"2. Trim the build context"}),"\n",(0,s.jsxs)(t.p,{children:["Add a ",(0,s.jsx)(t.code,{children:".dockerignore"})," that excludes ",(0,s.jsx)(t.code,{children:"node_modules/"}),", ",(0,s.jsx)(t.code,{children:"docs/"}),", test data, and build artefacts. The runner uploads the entire context before ",(0,s.jsx)(t.strong,{children:"any"})," Docker layer executes; shrinking 500 MB of junk can save 30-90 s. ",(0,s.jsx)(t.a,{href:"https://docs.docker.com/build/cache/optimize/?utm_source=chatgpt.com",children:"Docker Documentation"})]}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsx)(t.h2,{id:"3-re-order-your-dockerfile",children:"3. Re-order your Dockerfile"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-Dockerfile",children:"# syntax=docker/dockerfile:1.7\nFROM node:20-slim AS deps\nWORKDIR /app\n\n# 1\ufe0f\u20e3 copy only manifests\nCOPY package.json yarn.lock ./\nRUN --mount=type=cache,target=/root/.cache/yarn \\\n    yarn install --frozen-lockfile    # re-runs only when the lock-file changes\n\n# 2\ufe0f\u20e3 now copy the rest\nCOPY . .\n\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Because the dependency layer rarely changes, 60+ minutes of ",(0,s.jsx)(t.code,{children:"yarn install"})," drops to < 6 minutes the next time a PR arrives."]}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsxs)(t.h2,{id:"4-choose-the-right-layer-cache-backend",children:["4. Choose the ",(0,s.jsx)(t.em,{children:"right"})," layer-cache backend"]}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"Exporter"}),(0,s.jsx)(t.th,{children:"What\u2019s stored"}),(0,s.jsx)(t.th,{children:"Cold restore on GH runner"}),(0,s.jsx)(t.th,{children:"Best when"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"type=inline"})})}),(0,s.jsxs)(t.td,{children:["cache ",(0,s.jsx)(t.em,{children:"metadata"})," embedded in the image"]}),(0,s.jsx)(t.td,{children:"< 1 s (only tiny config pulled)"}),(0,s.jsx)(t.td,{children:"You already push the image anyway"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"type=registry"})})}),(0,s.jsxs)(t.td,{children:["full layers in a ",(0,s.jsx)(t.code,{children:"<image>-buildcache"})," tag"]}),(0,s.jsx)(t.td,{children:"5-30 s (downloads blobs)"}),(0,s.jsxs)(t.td,{children:["Huge images, need ",(0,s.jsx)(t.code,{children:"mode=max"})," granularity"]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"type=gha"})})}),(0,s.jsx)(t.td,{children:"tarball in GitHub Actions Cache (10 GB limit)"}),(0,s.jsx)(t.td,{children:"1-5 s (< 500 MB)"}),(0,s.jsx)(t.td,{children:"No private registry, branch-scoped caches"})]})]})]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.em,{children:"Inline feels snappiest"})," because BuildKit needs only the image manifest; layer blobs are fetched lazily. Note, though, that inline supports only ",(0,s.jsx)(t.code,{children:"mode=min"}),". For ARG/secret-heavy pipelines, flip to ",(0,s.jsx)(t.code,{children:"registry"}),". ",(0,s.jsx)(t.a,{href:"https://docs.docker.com/build/cache/backends/inline/?utm_source=chatgpt.com",children:"Docker Documentation"}),(0,s.jsx)(t.a,{href:"https://docs.docker.com/build/cache/backends/?utm_source=chatgpt.com",children:"Docker Documentation"}),(0,s.jsx)(t.a,{href:"https://docs.docker.com/build/cache/backends/gha/?utm_source=chatgpt.com",children:"Docker Documentation"}),(0,s.jsx)(t.a,{href:"https://docs.docker.com/build/ci/github-actions/cache/?utm_source=chatgpt.com",children:"Docker Documentation"})]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"Example call"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"docker buildx build \\\n  --push -t ghcr.io/acme/web:sha-$GITHUB_SHA \\\n  --cache-from type=registry,ref=ghcr.io/acme/web:buildcache \\\n  --cache-to   type=inline .\n\n"})}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsx)(t.h2,{id:"5-cache-mounts--the-buildkit-cache-dance",children:"5. Cache-mounts + the \u201cBuildKit Cache Dance\u201d"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-dockerfile",children:"RUN --mount=type=cache,target=/var/cache/apt     \\\n    --mount=type=cache,target=/root/.cache/pip   \\\n    pip install -r requirements.txt\n\n"})}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.code,{children:"type=cache"})," keeps bulky package folders ",(0,s.jsx)(t.strong,{children:"outside"})," the image graph, so later layer changes don\u2019t obliterate them. On GitHub-hosted runners those volumes disappear after each job\u2014unless you use ",(0,s.jsx)(t.strong,{children:"buildkit-cache-dance"})," to export/import them between runs:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-yaml",children:"- uses: reproducible-containers/buildkit-cache-dance@v2\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Result: ",(0,s.jsx)(t.em,{children:"52 min \u279c 8 min"})," even when ",(0,s.jsx)(t.code,{children:"package.json"})," ",(0,s.jsx)(t.em,{children:"does"})," change. ",(0,s.jsx)(t.a,{href:"https://github.com/reproducible-containers/buildkit-cache-dance?utm_source=chatgpt.com",children:"GitHub"}),(0,s.jsx)(t.a,{href:"https://github.com/moby/buildkit/issues/1673?utm_source=chatgpt.com",children:"GitHub"})]}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsx)(t.h2,{id:"6-tmpfs--unsafe-io---90-s-package-installs",children:"6. tmpfs + \u201cunsafe-io\u201d = < 90 s package installs"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-dockerfile",children:'RUN --mount=type=tmpfs,target=/var/lib/apt/lists  \\\n    --mount=type=cache,target=/var/cache/apt      \\\n    apt-get -o DPkg::Options::="--force-unsafe-io" \\\n        update && apt-get install -y git\n\n'})}),"\n",(0,s.jsxs)(d.A,{children:[(0,s.jsxs)("span",{children:[(0,s.jsx)("code",{children:"tmpfs"})," keeps apt's index in RAM\u2014zero disk writes."]}),(0,s.jsxs)("span",{children:[(0,s.jsx)("code",{children:"-force-unsafe-io"})," turns off every fsync in ",(0,s.jsx)("code",{children:"dpkg"}),", a safe bet in throw-away CI VMs. Ubuntu's base images already apply a partial version, but passing the flag still yields 15-30% extra speed."]})]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.a,{href:"https://docs.docker.com/reference/dockerfile/?utm_source=chatgpt.com",children:"Docker Documentation"}),(0,s.jsx)(t.a,{href:"https://www.reddit.com/r/debian/comments/1dz4jxk/how_can_you_speed_up_apt/?utm_source=chatgpt.com",children:"Reddit"}),(0,s.jsx)(t.a,{href:"https://gist.github.com/reegnz/990d0b01b5f5e8670f78257875d8daa8?utm_source=chatgpt.com",children:"Gist"})]}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsx)(t.h2,{id:"7-other-micro-wins",children:"7. Other micro-wins"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Pin base images by digest"})," to avoid surprise cache busts."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"buildx bake"})})," builds amd64+arm64 (or dev+prod variants) in parallel while sharing one cache. ",(0,s.jsx)(t.a,{href:"https://docs.docker.com/guides/bake/?utm_source=chatgpt.com",children:"Docker Documentation"})]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Garbage-collect"})," with ",(0,s.jsx)(t.code,{children:"buildx prune --filter keep-storage=20GB"}),". ",(0,s.jsx)(t.a,{href:"https://docs.docker.com/guides/bake/?utm_source=chatgpt.com",children:"Docker Documentation"}),(0,s.jsx)(t.a,{href:"https://docs.docker.com/build/ci/github-actions/cache/?utm_source=chatgpt.com",children:"Docker Documentation"})]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Self-hosted SSD runners"})," keep the entire BuildKit store between workflows\u2014zero network latency."]}),"\n"]}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsx)(t.h2,{id:"references",children:"References"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Docker Docs \u2013 [Inline cache] ",(0,s.jsx)(t.a,{href:"https://docs.docker.com/build/cache/backends/inline/?utm_source=chatgpt.com",children:"Docker Documentation"})]}),"\n",(0,s.jsxs)(t.li,{children:["Docker Docs \u2013 [Registry + GHA back-ends] ",(0,s.jsx)(t.a,{href:"https://docs.docker.com/build/cache/backends/?utm_source=chatgpt.com",children:"Docker Documentation"}),(0,s.jsx)(t.a,{href:"https://docs.docker.com/build/cache/backends/gha/?utm_source=chatgpt.com",children:"Docker Documentation"})]}),"\n",(0,s.jsxs)(t.li,{children:["Docker Docs \u2013 [Cache mounts] ",(0,s.jsx)(t.a,{href:"https://docs.docker.com/build/cache/optimize/?utm_source=chatgpt.com",children:"Docker Documentation"})]}),"\n",(0,s.jsxs)(t.li,{children:["BuildKit Cache Dance \u2013 GitHub ",(0,s.jsx)(t.a,{href:"https://github.com/reproducible-containers/buildkit-cache-dance?utm_source=chatgpt.com",children:"GitHub"})]}),"\n",(0,s.jsxs)(t.li,{children:["Dockerfile ",(0,s.jsx)(t.code,{children:"RUN --mount"})," reference ",(0,s.jsx)(t.a,{href:"https://docs.docker.com/reference/dockerfile/?utm_source=chatgpt.com",children:"Docker Documentation"})]}),"\n",(0,s.jsxs)(t.li,{children:["DPKG unsafe-io discussion ",(0,s.jsx)(t.a,{href:"https://www.reddit.com/r/debian/comments/1dz4jxk/how_can_you_speed_up_apt/?utm_source=chatgpt.com",children:"Reddit"}),(0,s.jsx)(t.a,{href:"https://gist.github.com/reegnz/990d0b01b5f5e8670f78257875d8daa8?utm_source=chatgpt.com",children:"Gist"})]}),"\n",(0,s.jsxs)(t.li,{children:["Buildx Bake guide & GC flags ",(0,s.jsx)(t.a,{href:"https://docs.docker.com/guides/bake/?utm_source=chatgpt.com",children:"Docker Documentation"}),(0,s.jsx)(t.a,{href:"https://docs.docker.com/build/ci/github-actions/cache/?utm_source=chatgpt.com",children:"Docker Documentation"})]}),"\n"]}),"\n",(0,s.jsx)(t.hr,{})]})}function m(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},5549:e=>{e.exports=JSON.parse('{"permalink":"/speed-up-docker-builds-on-github-actions","source":"@site/blog/2025-08-20-docker-build-times.mdx","title":"Speed up Docker Builds on Github actions","description":"Tricks to speed up docker builds","date":"2025-08-20T00:00:00.000Z","tags":[],"readingTime":4.61,"hasTruncateMarker":true,"authors":[],"frontMatter":{"slug":"speed-up-docker-builds-on-github-actions","title":"Speed up Docker Builds on Github actions","description":"Tricks to speed up docker builds","date":"2025-08-20T00:00:00.000Z","tags":[],"draft":false},"unlisted":false,"nextItem":{"title":"Video Rendering Pipeline for an AI-Driven Text-to-Video Platform","permalink":"/video-rendering-pipeline-for-an-ai-driven-text-to-video-platform"}}')},8453:(e,t,c)=>{c.d(t,{R:()=>i,x:()=>o});var n=c(6540);const s={},r=n.createContext(s);function i(e){const t=n.useContext(r);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),n.createElement(r.Provider,{value:t},e.children)}},8509:(e,t,c)=>{c.d(t,{A:()=>s});c(6540);var n=c(4848);function s({children:e,startNumber:t=1}){return(0,n.jsx)("ol",{style:{paddingLeft:"20px",margin:"16px 0",lineHeight:"1.6",listStyle:"decimal",listStyleType:"decimal",listStylePosition:"outside"},start:t,children:e.map((e,t)=>(0,n.jsx)("li",{style:{marginBottom:"8px",paddingLeft:"8px",display:"list-item"},children:e},t))})}},8700:(e,t,c)=>{c.d(t,{A:()=>s});c(6540);var n=c(4848);function s({items:e,startNumber:t=1}){return(0,n.jsx)("ol",{style:{paddingLeft:"20px",margin:"16px 0",lineHeight:"1.6",listStyle:"decimal",listStyleType:"decimal",listStylePosition:"outside"},start:t,children:e.map((e,t)=>(0,n.jsx)("li",{style:{marginBottom:"8px",paddingLeft:"8px",display:"list-item"},children:e},t))})}}}]);