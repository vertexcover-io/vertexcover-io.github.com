"use strict";(self.webpackChunkblog_vertexcover=self.webpackChunkblog_vertexcover||[]).push([[938],{614:(e,r,n)=>{n.d(r,{A:()=>i});n(6540);var s=n(4848);function i({children:e}){return(0,s.jsxs)("div",{className:"bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 my-5 border-l-4 border-l-blue-500 dark:border-l-blue-400",children:[(0,s.jsx)("strong",{className:"text-blue-600 dark:text-blue-400 text-sm uppercase tracking-wide font-semibold",children:"TL;DR:"}),(0,s.jsx)("div",{className:"mt-2 text-gray-800 dark:text-gray-200",children:e})]})}},1188:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>h,contentTitle:()=>a,default:()=>x,frontMatter:()=>o,metadata:()=>s,toc:()=>u});var s=n(5549),i=n(4848),t=n(8453),c=n(614),d=n(8700),l=n(8509);const o={slug:"speed-up-docker-builds-on-github-actions",title:"Speed up Docker Builds on Github actions",description:"Tricks to speed up docker builds",date:new Date("2025-08-20T00:00:00.000Z"),tags:[],draft:!1},a=void 0,h={authorsImageUrls:[]},u=[{value:"Why this matters",id:"why-this-matters",level:3},{value:"1. Turn on BuildKit &amp; Buildx everywhere",id:"1-turn-on-buildkit--buildx-everywhere",level:2},{value:"2. Trim the build context",id:"2-trim-the-build-context",level:2},{value:"3. Re-order your Dockerfile",id:"3-re-order-your-dockerfile",level:2},{value:"4. Choose the <em>right</em> layer-cache backend",id:"4-choose-the-right-layer-cache-backend",level:2},{value:"5. Cache-mounts + the \u201cBuildKit Cache Dance\u201d",id:"5-cache-mounts--the-buildkit-cache-dance",level:2},{value:"6. tmpfs + \u201cunsafe-io\u201d = &lt; 90 s package installs",id:"6-tmpfs--unsafe-io---90-s-package-installs",level:2},{value:"7. Other micro-wins",id:"7-other-micro-wins",level:2},{value:"References",id:"references",level:2}];function p(e){const r={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(c.A,{children:[(0,i.jsx)(d.A,{items:["Turn on BuildKit & Buildx everywhere","Reorder Dockerfile: copy package files first, then rest of code","Use cache-mounts with buildkit-cache-dance action","Pick the right cache backend (inline for speed, registry for large images)","Add tmpfs + unsafe-io flags for package installs"]}),(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Scenario"}),(0,i.jsx)(r.th,{children:"Avg. wall-clock"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"No caching"}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"1 h 10 m"})})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Layer-cache hit"}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"6 m"})})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Layer-cache miss (deps change)"}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"52 m"})})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Cache-mount + Cache-Dance"}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"8 m"})})]})]})]}),(0,i.jsx)(r.p,{children:"Stop rebuilding the world on every pull-request\u2014turn on these flags and ship faster."})]}),"\n","\n",(0,i.jsx)(r.h3,{id:"why-this-matters",children:"Why this matters"}),"\n",(0,i.jsxs)(r.blockquote,{children:["\n",(0,i.jsx)(r.p,{children:"70 min \u279c 6 min (deps unchanged) or 8 min (deps changed)."}),"\n",(0,i.jsx)(r.p,{children:"Those are the real numbers we saw after switching our Node + Python monorepo to the techniques below."}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Slow builds waste CI minutes, break focus, and block deploys."}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"1-turn-on-buildkit--buildx-everywhere",children:"1. Turn on BuildKit & Buildx everywhere"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:'# .github/workflows/build.yml\n- uses: docker/setup-buildx-action@v3   # spins up an isolated BuildKit builder\n- run: echo "DOCKER_BUILDKIT=1" >> $GITHUB_ENV\n\n'})}),"\n",(0,i.jsxs)(r.p,{children:["BuildKit unlocks layer caching, cache-mounts, ",(0,i.jsx)(r.code,{children:"RUN --mount"}),", and multi-platform bake (",(0,i.jsx)(r.a,{href:"https://docs.docker.com/build/ci/github-actions/cache/",children:"BuildKit documentation"}),")."]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"2-trim-the-build-context",children:"2. Trim the build context"}),"\n",(0,i.jsxs)(r.p,{children:["Add a ",(0,i.jsx)(r.code,{children:".dockerignore"})," that excludes ",(0,i.jsx)(r.code,{children:"node_modules/"}),", ",(0,i.jsx)(r.code,{children:"docs/"}),", test data, and build artefacts. The runner uploads the entire context before ",(0,i.jsx)(r.strong,{children:"any"})," Docker layer executes; shrinking 500 MB of junk can save 30-90 s (",(0,i.jsx)(r.a,{href:"https://docs.docker.com/build/cache/optimize/",children:"build optimization guide"}),")."]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"3-re-order-your-dockerfile",children:"3. Re-order your Dockerfile"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-Dockerfile",children:"# syntax=docker/dockerfile:1.7\nFROM node:20-slim AS deps\nWORKDIR /app\n\n# 1\ufe0f\u20e3 copy only manifests\nCOPY package.json yarn.lock ./\nRUN --mount=type=cache,target=/root/.cache/yarn \\\n    yarn install --frozen-lockfile    # re-runs only when the lock-file changes\n\n# 2\ufe0f\u20e3 now copy the rest\nCOPY . .\n\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Because the dependency layer rarely changes, 60+ minutes of ",(0,i.jsx)(r.code,{children:"yarn install"})," drops to < 6 minutes the next time a PR arrives."]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsxs)(r.h2,{id:"4-choose-the-right-layer-cache-backend",children:["4. Choose the ",(0,i.jsx)(r.em,{children:"right"})," layer-cache backend"]}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Exporter"}),(0,i.jsx)(r.th,{children:"What\u2019s stored"}),(0,i.jsx)(r.th,{children:"Cold restore on GH runner"}),(0,i.jsx)(r.th,{children:"Best when"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:(0,i.jsx)(r.code,{children:"type=inline"})})}),(0,i.jsxs)(r.td,{children:["cache ",(0,i.jsx)(r.em,{children:"metadata"})," embedded in the image"]}),(0,i.jsx)(r.td,{children:"< 1 s (only tiny config pulled)"}),(0,i.jsx)(r.td,{children:"You already push the image anyway"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:(0,i.jsx)(r.code,{children:"type=registry"})})}),(0,i.jsxs)(r.td,{children:["full layers in a ",(0,i.jsx)(r.code,{children:"<image>-buildcache"})," tag"]}),(0,i.jsx)(r.td,{children:"5-30 s (downloads blobs)"}),(0,i.jsxs)(r.td,{children:["Huge images, need ",(0,i.jsx)(r.code,{children:"mode=max"})," granularity"]})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:(0,i.jsx)(r.code,{children:"type=gha"})})}),(0,i.jsx)(r.td,{children:"tarball in GitHub Actions Cache (10 GB limit)"}),(0,i.jsx)(r.td,{children:"1-5 s (< 500 MB)"}),(0,i.jsx)(r.td,{children:"No private registry, branch-scoped caches"})]})]})]}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.em,{children:"Inline feels snappiest"})," because BuildKit needs only the image manifest; layer blobs are fetched lazily. Note, though, that inline supports only ",(0,i.jsx)(r.code,{children:"mode=min"}),". For ARG/secret-heavy pipelines, flip to ",(0,i.jsx)(r.code,{children:"registry"})," (",(0,i.jsx)(r.a,{href:"https://docs.docker.com/build/cache/backends/inline/",children:"inline cache guide"}),", ",(0,i.jsx)(r.a,{href:"https://docs.docker.com/build/cache/backends/",children:"cache backends overview"}),", ",(0,i.jsx)(r.a,{href:"https://docs.docker.com/build/cache/backends/gha/",children:"GitHub Actions cache"}),")."]}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"Example call"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"docker buildx build \\\n  --push -t ghcr.io/acme/web:sha-$GITHUB_SHA \\\n  --cache-from type=registry,ref=ghcr.io/acme/web:buildcache \\\n  --cache-to   type=inline .\n\n"})}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"5-cache-mounts--the-buildkit-cache-dance",children:"5. Cache-mounts + the \u201cBuildKit Cache Dance\u201d"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dockerfile",children:"RUN --mount=type=cache,target=/var/cache/apt     \\\n    --mount=type=cache,target=/root/.cache/pip   \\\n    pip install -r requirements.txt\n\n"})}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"type=cache"})," keeps bulky package folders ",(0,i.jsx)(r.strong,{children:"outside"})," the image graph, so later layer changes don\u2019t obliterate them. On GitHub-hosted runners those volumes disappear after each job\u2014unless you use ",(0,i.jsx)(r.strong,{children:"buildkit-cache-dance"})," to export/import them between runs:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:"- uses: reproducible-containers/buildkit-cache-dance@v2\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Result: ",(0,i.jsx)(r.em,{children:"52 min \u279c 8 min"})," even when ",(0,i.jsx)(r.code,{children:"package.json"})," ",(0,i.jsx)(r.em,{children:"does"})," change (",(0,i.jsx)(r.a,{href:"https://github.com/reproducible-containers/buildkit-cache-dance",children:"buildkit-cache-dance repo"}),", ",(0,i.jsx)(r.a,{href:"https://github.com/moby/buildkit/issues/1673",children:"BuildKit cache issue discussion"}),")."]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"6-tmpfs--unsafe-io---90-s-package-installs",children:"6. tmpfs + \u201cunsafe-io\u201d = < 90 s package installs"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dockerfile",children:'RUN --mount=type=tmpfs,target=/var/lib/apt/lists  \\\n    --mount=type=cache,target=/var/cache/apt      \\\n    apt-get -o DPkg::Options::="--force-unsafe-io" \\\n        update && apt-get install -y git\n\n'})}),"\n",(0,i.jsxs)(l.A,{children:[(0,i.jsxs)("span",{children:[(0,i.jsx)("code",{children:"tmpfs"})," keeps apt's index in RAM\u2014zero disk writes."]}),(0,i.jsxs)("span",{children:[(0,i.jsx)("code",{children:"-force-unsafe-io"})," turns off every fsync in ",(0,i.jsx)("code",{children:"dpkg"}),", a safe bet in throw-away CI VMs. Ubuntu's base images already apply a partial version, but passing the flag still yields 15-30% extra speed."]})]}),"\n",(0,i.jsxs)(r.p,{children:["(",(0,i.jsx)(r.a,{href:"https://docs.docker.com/reference/dockerfile/",children:"Dockerfile RUN reference"}),", ",(0,i.jsx)(r.a,{href:"https://www.reddit.com/r/debian/comments/1dz4jxk/how_can_you_speed_up_apt/",children:"APT speed optimization discussion"}),", ",(0,i.jsx)(r.a,{href:"https://gist.github.com/reegnz/990d0b01b5f5e8670f78257875d8daa8",children:"unsafe-io examples"}),")."]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"7-other-micro-wins",children:"7. Other micro-wins"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Pin base images by digest"})," to avoid surprise cache busts."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:(0,i.jsx)(r.code,{children:"buildx bake"})})," builds amd64+arm64 (or dev+prod variants) in parallel while sharing one cache (",(0,i.jsx)(r.a,{href:"https://docs.docker.com/guides/bake/",children:"buildx bake guide"}),")."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Garbage-collect"})," with ",(0,i.jsx)(r.code,{children:"buildx prune --filter keep-storage=20GB"})," (",(0,i.jsx)(r.a,{href:"https://docs.docker.com/build/ci/github-actions/cache/",children:"cache management guide"}),")."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Self-hosted SSD runners"})," keep the entire BuildKit store between workflows\u2014zero network latency."]}),"\n"]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"references",children:"References"}),"\n",(0,i.jsxs)("ul",{style:{paddingLeft:"20px",margin:"16px 0",lineHeight:"1.6"},children:[(0,i.jsx)("li",{style:{marginBottom:"8px"},children:(0,i.jsxs)(r.p,{children:[(0,i.jsx)("a",{href:"https://docs.docker.com/build/cache/backends/inline/",target:"_blank",rel:"noopener noreferrer",children:"Inline cache documentation"})," - Docker Docs"]})}),(0,i.jsx)("li",{style:{marginBottom:"8px"},children:(0,i.jsxs)(r.p,{children:[(0,i.jsx)("a",{href:"https://docs.docker.com/build/cache/backends/",target:"_blank",rel:"noopener noreferrer",children:"Cache backends overview"})," - Docker Docs"]})}),(0,i.jsx)("li",{style:{marginBottom:"8px"},children:(0,i.jsxs)(r.p,{children:[(0,i.jsx)("a",{href:"https://docs.docker.com/build/cache/backends/gha/",target:"_blank",rel:"noopener noreferrer",children:"GitHub Actions cache backend"})," - Docker Docs"]})}),(0,i.jsx)("li",{style:{marginBottom:"8px"},children:(0,i.jsxs)(r.p,{children:[(0,i.jsx)("a",{href:"https://docs.docker.com/build/cache/optimize/",target:"_blank",rel:"noopener noreferrer",children:"Build cache optimization guide"})," - Docker Docs"]})}),(0,i.jsx)("li",{style:{marginBottom:"8px"},children:(0,i.jsxs)(r.p,{children:[(0,i.jsx)("a",{href:"https://github.com/reproducible-containers/buildkit-cache-dance",target:"_blank",rel:"noopener noreferrer",children:"BuildKit Cache Dance repository"})," - GitHub"]})}),(0,i.jsx)("li",{style:{marginBottom:"8px"},children:(0,i.jsxs)(r.p,{children:[(0,i.jsx)("a",{href:"https://docs.docker.com/reference/dockerfile/",target:"_blank",rel:"noopener noreferrer",children:"Dockerfile RUN --mount reference"})," - Docker Docs"]})}),(0,i.jsx)("li",{style:{marginBottom:"8px"},children:(0,i.jsxs)(r.p,{children:[(0,i.jsx)("a",{href:"https://www.reddit.com/r/debian/comments/1dz4jxk/how_can_you_speed_up_apt/",target:"_blank",rel:"noopener noreferrer",children:"APT speed optimization discussion"})," - Reddit"]})}),(0,i.jsx)("li",{style:{marginBottom:"8px"},children:(0,i.jsxs)(r.p,{children:[(0,i.jsx)("a",{href:"https://gist.github.com/reegnz/990d0b01b5f5e8670f78257875d8daa8",target:"_blank",rel:"noopener noreferrer",children:"DPKG unsafe-io examples"})," - GitHub Gist"]})}),(0,i.jsx)("li",{style:{marginBottom:"8px"},children:(0,i.jsxs)(r.p,{children:[(0,i.jsx)("a",{href:"https://docs.docker.com/guides/bake/",target:"_blank",rel:"noopener noreferrer",children:"Buildx bake guide"})," - Docker Docs"]})}),(0,i.jsx)("li",{style:{marginBottom:"8px"},children:(0,i.jsxs)(r.p,{children:[(0,i.jsx)("a",{href:"https://docs.docker.com/build/ci/github-actions/cache/",target:"_blank",rel:"noopener noreferrer",children:"Cache management on GitHub Actions"})," - Docker Docs"]})})]}),"\n",(0,i.jsx)(r.hr,{})]})}function x(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(p,{...e})}):p(e)}},5549:e=>{e.exports=JSON.parse('{"permalink":"/speed-up-docker-builds-on-github-actions","source":"@site/blog/2025-08-20-docker-build-times.mdx","title":"Speed up Docker Builds on Github actions","description":"Tricks to speed up docker builds","date":"2025-08-20T00:00:00.000Z","tags":[],"readingTime":5.12,"hasTruncateMarker":true,"authors":[],"frontMatter":{"slug":"speed-up-docker-builds-on-github-actions","title":"Speed up Docker Builds on Github actions","description":"Tricks to speed up docker builds","date":"2025-08-20T00:00:00.000Z","tags":[],"draft":false},"unlisted":false,"nextItem":{"title":"Video Rendering Pipeline for an AI-Driven Text-to-Video Platform","permalink":"/video-rendering-pipeline-for-an-ai-driven-text-to-video-platform"}}')},8453:(e,r,n)=>{n.d(r,{R:()=>c,x:()=>d});var s=n(6540);const i={},t=s.createContext(i);function c(e){const r=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),s.createElement(t.Provider,{value:r},e.children)}},8509:(e,r,n)=>{n.d(r,{A:()=>i});n(6540);var s=n(4848);function i({children:e,startNumber:r=1}){return(0,s.jsx)("ol",{style:{paddingLeft:"20px",margin:"16px 0",lineHeight:"1.6",listStyle:"decimal",listStyleType:"decimal",listStylePosition:"outside"},start:r,children:e.map((e,r)=>(0,s.jsx)("li",{style:{marginBottom:"8px",paddingLeft:"8px",display:"list-item"},children:e},r))})}},8700:(e,r,n)=>{n.d(r,{A:()=>i});n(6540);var s=n(4848);function i({items:e,startNumber:r=1}){return(0,s.jsx)("ol",{style:{paddingLeft:"20px",margin:"16px 0",lineHeight:"1.6",listStyle:"decimal",listStyleType:"decimal",listStylePosition:"outside"},start:r,children:e.map((e,r)=>(0,s.jsx)("li",{style:{marginBottom:"8px",paddingLeft:"8px",display:"list-item"},children:e},r))})}}}]);